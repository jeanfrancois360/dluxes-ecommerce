// Luxury E-commerce Platform - Database Schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Management
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  firstName     String
  lastName      String
  password      String?   // Nullable for passwordless auth
  role          UserRole  @default(CUSTOMER)
  avatar        String?
  phone         String?
  emailVerified Boolean   @default(false)
  phoneVerified Boolean   @default(false)

  // 2FA
  twoFactorEnabled Boolean @default(false)
  twoFactorSecret  String?

  // Account status
  isActive      Boolean   @default(true)
  isSuspended   Boolean   @default(false)
  lastLoginAt   DateTime?
  lastLoginIp   String?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  addresses       Address[]
  orders          Order[]
  carts           Cart[]
  preferences     UserPreferences?
  wishlistItems   WishlistItem[]
  productViews    ProductView[]
  productLikes    ProductLike[]
  reviews         Review[]
  sessions        UserSession[]
  magicLinks      MagicLink[]
  loginAttempts   LoginAttempt[]
  passwordResets  PasswordReset[]
  refreshTokens   RefreshToken[]
  store           Store?           // Seller's store (only for SELLER role)

  @@index([email])
  @@index([lastLoginAt])
  @@map("users")
}

enum UserRole {
  BUYER         // Can purchase products
  SELLER        // Can sell products AND purchase (has all buyer capabilities)
  CUSTOMER      // Legacy - equivalent to BUYER
  ADMIN
  SUPER_ADMIN
}

model UserPreferences {
  id           String  @id @default(cuid())
  userId       String  @unique
  newsletter   Boolean @default(false)
  notifications Boolean @default(true)
  currency     String  @default("USD")
  language     String  @default("en")

  // Luxury UI preferences
  theme        String  @default("dark") // dark, light, auto
  layoutMode   String  @default("elegant") // elegant, compact

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

model Address {
  id         String  @id @default(cuid())
  userId     String
  firstName  String
  lastName   String
  company    String?
  address1   String
  address2   String?
  city       String
  province   String
  country    String
  postalCode String
  phone      String?
  isDefault  Boolean @default(false)

  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  shippingOrders    Order[] @relation("ShippingAddress")
  billingOrders     Order[] @relation("BillingAddress")

  @@index([userId])
  @@map("addresses")
}

// ============================================================================
// Seller Store Management
// ============================================================================

model Store {
  id               String       @id @default(cuid())
  userId           String       @unique  // One store per seller

  // Store Information
  name             String
  slug             String       @unique
  description      String?      @db.Text
  logo             String?
  banner           String?

  // Contact & Legal
  email            String
  phone            String?
  website          String?
  taxId            String?      // Business tax ID

  // Address
  address1         String?
  address2         String?
  city             String?
  province         String?
  country          String?
  postalCode       String?

  // Store Status
  status           StoreStatus  @default(PENDING)
  isActive         Boolean      @default(true)
  verified         Boolean      @default(false)
  verifiedAt       DateTime?

  // Store Policies
  returnPolicy     String?      @db.Text
  shippingPolicy   String?      @db.Text
  termsConditions  String?      @db.Text

  // Analytics & Metrics
  totalSales       Decimal      @db.Decimal(12, 2) @default(0)
  totalOrders      Int          @default(0)
  totalProducts    Int          @default(0)
  rating           Decimal?     @db.Decimal(3, 2)  // Average store rating
  reviewCount      Int          @default(0)

  // Store Settings
  currency         String       @default("USD")
  timezone         String       @default("UTC")

  // SEO
  metaTitle        String?
  metaDescription  String?

  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  // Relations
  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  products         Product[]    // Products belonging to this store

  @@index([slug])
  @@index([status])
  @@index([userId])
  @@index([rating])
  @@map("stores")
}

enum StoreStatus {
  PENDING        // Awaiting admin approval
  ACTIVE         // Active and selling
  SUSPENDED      // Temporarily suspended
  INACTIVE       // Deactivated by seller
  REJECTED       // Rejected by admin
}

// Product Catalog
model Product {
  id               String         @id @default(cuid())
  storeId          String?        // Seller's store (optional for admin-created products)
  name             String
  slug             String         @unique
  description      String         @db.Text
  shortDescription String?
  categoryId       String?        // Changed to relation
  price            Decimal        @db.Decimal(10, 2)
  compareAtPrice   Decimal?       @db.Decimal(10, 2)
  status           ProductStatus  @default(DRAFT)
  featured         Boolean        @default(false)
  inventory        Int            @default(0)
  previousStock    Int?           // For smooth inventory transition animations
  weight           Decimal?       @db.Decimal(10, 2)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  // Luxury UI Features
  heroImage        String?        // Primary hero image for product cards
  gallery          Json?          // Array of {type: 'image'|'video'|'360', url: string, thumbnail?: string}
  badges           String[]       // ["New", "Featured", "Sale", "Limited Edition"]
  displayOrder     Int            @default(0) // For curated ordering

  // Analytics & Engagement
  viewCount        Int            @default(0)
  likeCount        Int            @default(0)
  rating           Decimal?       @db.Decimal(3, 2) // Average rating (0-5)
  reviewCount      Int            @default(0)

  // Full-text Search (PostgreSQL tsvector)
  searchVector     Unsupported("tsvector")?

  // SEO & Metadata
  metaTitle        String?
  metaDescription  String?
  seoKeywords      String[]

  // Product attributes for filtering
  colors           String[]       // Color swatches for elegant filtering
  sizes            String[]       // Size options
  materials        String[]       // Material tags
  dimensions       Json?          // {length, width, height, unit}

  // Relations
  store            Store?          @relation(fields: [storeId], references: [id], onDelete: SetNull)
  category         Category?       @relation(fields: [categoryId], references: [id])
  images           ProductImage[]
  variants         ProductVariant[]
  tags             ProductTag[]
  orderItems       OrderItem[]
  cartItems        CartItem[]
  wishlistItems    WishlistItem[]
  views            ProductView[]
  likes            ProductLike[]
  reviews          Review[]
  collections      ProductCollection[]
  recommendations  ProductRecommendation[] @relation("RecommendedProducts")
  sourceRecommendations ProductRecommendation[] @relation("SourceProducts")

  @@index([slug])
  @@index([storeId])
  @@index([categoryId])
  @@index([status])
  @@index([featured])
  @@index([displayOrder])
  @@index([viewCount])
  @@index([rating])
  @@index([searchVector], type: Gin)
  @@map("products")
}

// Category Model for elegant hierarchical organization
model Category {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?  @db.Text
  parentId    String?
  image       String?
  icon        String?  // Icon for elegant UI
  displayOrder Int     @default(0)
  isActive    Boolean  @default(true)

  // UI Styling
  colorScheme  Json?   // {primary: '#color', secondary: '#color'}

  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  products    Product[]

  @@index([slug])
  @@index([parentId])
  @@index([displayOrder])
  @@map("categories")
}

// Collection Model for curated product sets
model Collection {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?  @db.Text
  image       String?

  // Luxury UI
  heroImage   String?
  theme       Json?    // {colors: [], fonts: [], mood: 'elegant'}
  displayOrder Int     @default(0)

  // Visibility
  isActive    Boolean  @default(true)
  isFeatured  Boolean  @default(false)
  startDate   DateTime?
  endDate     DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  products    ProductCollection[]

  @@index([slug])
  @@index([isFeatured])
  @@index([displayOrder])
  @@map("collections")
}

model ProductCollection {
  id           String     @id @default(cuid())
  productId    String
  collectionId String
  displayOrder Int        @default(0)
  createdAt    DateTime   @default(now())

  product    Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  collection Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  @@unique([productId, collectionId])
  @@index([collectionId])
  @@index([displayOrder])
  @@map("product_collections")
}

enum ProductStatus {
  DRAFT
  ACTIVE
  ARCHIVED
  OUT_OF_STOCK
}

model ProductImage {
  id        String  @id @default(cuid())
  productId String
  url       String
  alt       String
  width     Int
  height    Int
  isPrimary Boolean @default(false)

  // Luxury UI
  displayOrder Int    @default(0)
  thumbnail    String? // Optimized thumbnail for galleries
  blurHash     String? // BlurHash for elegant loading states

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([displayOrder])
  @@map("product_images")
}

model ProductVariant {
  id             String  @id @default(cuid())
  productId      String
  name           String
  sku            String  @unique
  price          Decimal @db.Decimal(10, 2)
  compareAtPrice Decimal? @db.Decimal(10, 2)
  inventory      Int     @default(0)
  previousStock  Int?    // For smooth inventory animations
  options        Json    // {size: 'M', color: 'Black', material: 'Silk'}

  // Elegant UI data
  image          String? // Variant-specific image
  colorHex       String? // #000000 for color swatches
  colorName      String? // "Midnight Black"
  sizeChart      Json?   // Size guide data
  displayOrder   Int     @default(0)

  // Availability
  isAvailable    Boolean @default(true)
  lowStockThreshold Int  @default(5)

  product    Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  orderItems OrderItem[]
  cartItems  CartItem[]

  @@index([productId])
  @@index([sku])
  @@index([isAvailable])
  @@map("product_variants")
}

model ProductTag {
  id        String   @id @default(cuid())
  productId String
  name      String
  createdAt DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, name])
  @@index([name])
  @@map("product_tags")
}

// Shopping Cart
model Cart {
  id        String   @id @default(cuid())
  userId    String?
  sessionId String
  subtotal  Decimal  @db.Decimal(10, 2) @default(0)
  discount  Decimal  @db.Decimal(10, 2) @default(0)
  total     Decimal  @db.Decimal(10, 2) @default(0)
  currency  String   @default("USD")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user  User?      @relation(fields: [userId], references: [id], onDelete: SetNull)
  items CartItem[]

  @@index([userId])
  @@index([sessionId])
  @@map("carts")
}

model CartItem {
  id        String   @id @default(cuid())
  cartId    String
  productId String
  variantId String?
  name      String
  sku       String
  price     Decimal  @db.Decimal(10, 2)
  quantity  Int
  image     String?
  metadata  Json?    // For personalization options, gift wrapping, etc.

  // Smooth animations
  previousQuantity Int? // For transition effects
  addedAt   DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cart    Cart            @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product         @relation(fields: [productId], references: [id])
  variant ProductVariant? @relation(fields: [variantId], references: [id])

  @@index([cartId])
  @@index([productId])
  @@map("cart_items")
}

// Orders
model Order {
  id                String        @id @default(cuid())
  orderNumber       String        @unique
  userId            String
  subtotal          Decimal       @db.Decimal(10, 2)
  shipping          Decimal       @db.Decimal(10, 2)
  tax               Decimal       @db.Decimal(10, 2)
  discount          Decimal       @db.Decimal(10, 2) @default(0)
  total             Decimal       @db.Decimal(10, 2)
  currency          String        @default("USD")
  status            OrderStatus   @default(PENDING)
  paymentStatus     PaymentStatus @default(PENDING)
  paymentMethod     PaymentMethod?
  paidAt            DateTime?
  shippingAddressId String
  billingAddressId  String?
  notes             String?       @db.Text
  metadata          Json?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  user            User      @relation(fields: [userId], references: [id])
  shippingAddress Address   @relation("ShippingAddress", fields: [shippingAddressId], references: [id])
  billingAddress  Address?  @relation("BillingAddress", fields: [billingAddressId], references: [id])
  items           OrderItem[]
  timeline        OrderTimeline[] // Beautiful order tracking timeline

  @@index([userId])
  @@index([orderNumber])
  @@index([status])
  @@index([paymentStatus])
  @@map("orders")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  AUTHORIZED
  PAID
  PARTIALLY_REFUNDED
  REFUNDED
  FAILED
}

enum PaymentMethod {
  CREDIT_CARD
  PAYPAL
  STRIPE
  BANK_TRANSFER
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  productId String
  variantId String?
  name      String
  sku       String
  quantity  Int
  price     Decimal @db.Decimal(10, 2)
  total     Decimal @db.Decimal(10, 2)
  image     String?

  order   Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product         @relation(fields: [productId], references: [id])
  variant ProductVariant? @relation(fields: [variantId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

// Order Timeline for elegant tracking UI
model OrderTimeline {
  id          String   @id @default(cuid())
  orderId     String
  status      OrderStatus
  title       String   // "Order Confirmed", "Shipped", etc.
  description String?  @db.Text
  location    String?  // Shipping location
  icon        String?  // Icon name for UI
  metadata    Json?    // Additional tracking data

  createdAt   DateTime @default(now())

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([createdAt])
  @@map("order_timeline")
}

// Wishlist for premium UX
model WishlistItem {
  id        String   @id @default(cuid())
  userId    String
  productId String
  notes     String?  @db.Text
  priority  Int      @default(0) // For sorting

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId])
  @@index([productId])
  @@index([priority])
  @@map("wishlist_items")
}

// Product Views for analytics
model ProductView {
  id        String   @id @default(cuid())
  productId String
  userId    String?
  sessionId String?  // For anonymous tracking

  // Analytics
  referrer  String?
  userAgent String?
  duration  Int?     // Time spent viewing (seconds)

  createdAt DateTime @default(now())

  user    User?   @relation(fields: [userId], references: [id], onDelete: SetNull)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([userId])
  @@index([sessionId])
  @@index([createdAt])
  @@map("product_views")
}

// Product Likes for engagement
model ProductLike {
  id        String   @id @default(cuid())
  productId String
  userId    String

  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([productId])
  @@index([userId])
  @@map("product_likes")
}

// Reviews with rich features
model Review {
  id        String   @id @default(cuid())
  productId String
  userId    String
  orderId   String?  // Verified purchase

  rating    Int      // 1-5 stars
  title     String?
  comment   String   @db.Text

  // Rich media
  images    String[] // Review photos
  videos    String[] // Review videos

  // Verification
  isVerified Boolean @default(false)

  // Moderation
  isApproved Boolean @default(false)
  isPinned   Boolean @default(false)

  // Engagement
  helpfulCount Int   @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([userId])
  @@index([rating])
  @@index([isApproved])
  @@index([createdAt])
  @@map("reviews")
}

// Product Recommendations Engine
model ProductRecommendation {
  id               String   @id @default(cuid())
  sourceProductId  String   // Product being viewed
  recommendedProductId String // Recommended product

  // Algorithm metadata
  score       Decimal  @db.Decimal(5, 4) // Relevance score 0-1
  algorithm   String   // "collaborative", "content-based", "trending"
  reason      String?  // "Customers also bought", "Similar items"

  // Performance tracking
  impressions Int      @default(0)
  clicks      Int      @default(0)
  conversions Int      @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  sourceProduct      Product @relation("SourceProducts", fields: [sourceProductId], references: [id], onDelete: Cascade)
  recommendedProduct Product @relation("RecommendedProducts", fields: [recommendedProductId], references: [id], onDelete: Cascade)

  @@unique([sourceProductId, recommendedProductId])
  @@index([sourceProductId])
  @@index([score])
  @@map("product_recommendations")
}

// ============================================================================
// Enhanced Authentication & Security
// ============================================================================

// User Sessions for device management
model UserSession {
  id           String   @id @default(cuid())
  userId       String
  token        String   @unique

  // Device Information
  deviceName   String?
  deviceType   String?  // "desktop", "mobile", "tablet"
  browser      String?
  os           String?
  ipAddress    String?
  location     String?  // City, Country

  // Session Status
  isActive     Boolean  @default(true)
  lastActiveAt DateTime @default(now())
  expiresAt    DateTime

  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@index([isActive])
  @@map("user_sessions")
}

// Magic Link Authentication (Passwordless)
model MagicLink {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  email     String

  // Status
  used      Boolean  @default(false)
  usedAt    DateTime?
  expiresAt DateTime

  // Tracking
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("magic_links")
}

// Rate Limiting & Security
model LoginAttempt {
  id        String   @id @default(cuid())
  userId    String?
  email     String
  ipAddress String
  userAgent String?

  // Status
  success   Boolean  @default(false)
  reason    String?  // "invalid_password", "account_locked", etc.

  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([email])
  @@index([ipAddress])
  @@index([createdAt])
  @@map("login_attempts")
}

// Password Reset Tokens
model PasswordReset {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique

  // Status
  used      Boolean  @default(false)
  usedAt    DateTime?
  expiresAt DateTime

  // Tracking
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("password_resets")
}

// Refresh Tokens for JWT authentication
model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique  // Hashed token

  // Device Information
  deviceType   String?  // "desktop", "mobile", "tablet"
  browser      String?
  os           String?
  ipAddress    String?

  // Status
  isActive     Boolean  @default(true)
  isRevoked    Boolean  @default(false)
  revokedAt    DateTime?
  expiresAt    DateTime

  // Tracking
  lastUsedAt   DateTime @default(now())
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@index([isActive])
  @@map("refresh_tokens")
}
